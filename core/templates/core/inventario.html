{% extends 'core/base.html' %}
{% load static %}
{% block content %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h3 class="fw-bold mb-0">Inventario</h3>
        <small class="text-muted">
            Gesti√≥n y control de productos
        </small>
    </div>

    <div class="text-end">
        <span class="badge bg-light text-dark border">
            Total productos: {{ page_obj.paginator.count }}
        </span>
    </div>
</div>
<!-- =======================
 ACCIONES SUPERIORES
======================== -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex justify-content-between flex-wrap gap-3 align-items-center">

        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#modalProducto">
                + Nuevo producto
            </button>

            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCategoria">
                Categor√≠as
            </button>
        </div>

        <div class="d-flex gap-2 flex-wrap align-items-center">

            <a href="{% url 'exportar_excel' %}" class="btn btn-outline-dark btn-sm">
                Exportar Excel
            </a>

            <a href="{% url 'exportar_excel_bajo' %}" class="btn btn-outline-warning btn-sm">
                Stock bajo
            </a>

            <form method="POST" enctype="multipart/form-data" class="d-flex gap-2">
                {% csrf_token %}
                <input type="file" name="archivo_excel" class="form-control form-control-sm">
                <button type="submit" name="subir_excel" class="btn btn-success btn-sm">
                    Importar
                </button>
            </form>

        </div>

    </div>
</div>
<!-- =======================
 FILTROS
======================== -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <form method="GET" id="form-filtros" class="row g-3 align-items-end">
        <div class="col-md-4">
                <label class="form-label small text-muted">Buscar</label>
                <input type="text" name="nombre" id="buscarInventario" 
                    placeholder="Nombre, folio o referencia..."
                    class="form-control"
                    value="{{ request.GET.nombre }}">
            </div>

            <div class="col-md-4">
                <label class="form-label small text-muted">Categor√≠a</label>
                <select name="categoria" class="form-select">
                    <option value="">Todas</option>
                    {% for cat in categorias %}
                    <option value="{{ cat.id }}"
                        {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                        {{ cat.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 d-flex gap-2">
                <button class="btn btn-primary w-100">
                    Aplicar filtros
                </button>
                <a href="{% url 'inventario' %}" class="btn btn-light border w-100">
                    Limpiar
                </a>
            </div>

        </form>
    </div>
</div>
<!-- =======================
 TABLA INVENTARIO
======================== -->
<form method="POST" action="{% url 'imprimir_etiquetas_masivo' %}" id="form-imprimir">
    {% csrf_token %}
</form>
<div class="card shadow-sm border-0">
    <div class="card-body p-0">

        <div class="table-responsive">
            <table class="table align-middle table-hover mb-0" id="tabla-inventario">

                <thead class="bg-light border-bottom">
                    <tr class="small text-muted text-uppercase">
                        <th><input type="checkbox" id="check-all"></th>
                        <th>Folio</th>
                        <th>Referencia</th>
                        <th>Producto</th>
                        <th>Categor√≠a</th>
                        <th class="text-end">Precio</th>
                        <th class="text-end">Mayoreo</th>
                        <th>Unidad</th>
                        <th class="text-center">Virtual</th>
                        <th class="text-center">F√≠sico</th>
                        <th class="text-center">Estado</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>

            <tbody id="tabla-body">
            {% for stock in page_obj %}
            <tr
                {% if stock.stock_fisico == 0 %}
                    class="table-danger"
                {% elif stock.stock_fisico <= 3 %}
                    class="table-warning"
                {% endif %}
            >
                <td>
                   <input type="checkbox" name="productos" value="{{ stock.producto.id }}" form="form-imprimir">
                </td>
                <td>{{ stock.producto.no_folio }}</td>
                <td>{{ stock.producto.referencia }}</td>
                <td>{{ stock.producto.nombre }}</td>
                <td>{{ stock.producto.categoria }}</td>
                <td>${{ stock.producto.precio }}</td>
                <td>${{ stock.producto.precio_mayoreo }}</td>
                <td>{{ stock.producto.unidad_medida }}</td>
                <td>{{ stock.stock_virtual }}</td>
                <td>{{ stock.stock_fisico }}</td>

                <td>
                   {% if stock.stock_fisico == 0 %}
                    <span class="badge bg-danger-subtle text-danger border">
                        Agotado
                    </span>
                    {% elif stock.stock_fisico <= 3 %}
                    <span class="badge bg-warning-subtle text-warning border">
                        Bajo
                    </span>
                    {% else %}
                    <span class="badge bg-success-subtle text-success border">
                        Disponible
                    </span>
                    {% endif %}
                </td>

                <td>
                {% if request.user.rol == 'ADMIN' %}
                    <form method="POST" class="d-flex gap-1 mb-1 auto-save">
                        {% csrf_token %}
                        <input type="hidden" name="stock_id" value="{{ stock.id }}">
                        <input type="hidden" name="producto_id" value="{{ stock.producto.id }}">

                        <input type="number" name="stock_virtual" value="{{ stock.stock_virtual }}"
                            class="form-control form-control-sm stock-input" min="0">

                        <input type="number" name="stock_fisico" value="{{ stock.stock_fisico }}"
                            class="form-control form-control-sm stock-input" min="0">
                    </form>

                    <a href="{% url 'inventario' %}?editar={{ stock.producto.id }}"
                        class="btn btn-sm btn-outline-warning">
                        ‚úè Editar
                    </a>
                {% endif %}

                {% if request.user.rol == 'USUARIO' and stock.stock_virtual > 0 %}
                    <form method="POST" action="{% url 'transferir_stock' stock.id %}">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-primary">Transferir</button>
                    </form>
                {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- =======================
 PAGINACI√ìN
======================== -->
<nav class="mt-4">
    <ul class="pagination pagination-sm justify-content-center">

        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">&laquo;</a>
            </li>
        {% endif %}

        <li class="page-item active">
            <span class="page-link">
                {{ page_obj.number }}
            </span>
        </li>

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                    &raquo;
                </a>
            </li>
        {% endif %}

    </ul>
</nav>
    <button type="submit" form="form-imprimir" class="btn btn-primary">
    üè∑ Imprimir etiquetas seleccionadas
</button>

<!-- =======================
 MODAL CATEGORIA (MEJORADO)
======================== -->
<div class="modal fade" id="modalCategoria">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form method="POST">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">üìÇ Categor√≠as</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">

                        <!-- FORM -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Nombre de la categor√≠a</label>
                            {{ form_categoria.nombre }}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Prefijo (opcional)</label>
                            {{ form_categoria.prefijo }}
                        </div>

                        <!-- LISTADO -->
                        <div class="col-md-8 mt-3">
                            <h6 class="fw-semibold mb-2">Categor√≠as registradas</h6>

                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Prefijo</th>
                                        <th style="width:90px">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for categoria in categorias %}
                                    <tr>
                                        <td>{{ categoria.nombre }}</td>
                                        <td>{{ categoria.prefijo }}</td>
                                        <td>
                                            <form method="POST"
                                                  action="{% url 'eliminar_categoria' categoria.id %}">
                                                {% csrf_token %}
                                                <button class="btn btn-sm btn-outline-danger">
                                                    üóë
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-muted text-center">
                                            Sin categor√≠as
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button class="btn btn-success" name="guardar_categoria">
                        Guardar
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- =======================
 MODAL PRODUCTO (LABELS)
======================== -->
<div class="modal fade" id="modalProducto" 
     data-bs-backdrop="static" 
     data-bs-keyboard="false"
     tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="POST" class="modal-content" id="formProducto">
            {% csrf_token %}

            <div class="modal-header">
                <h5 class="modal-title">üì¶ Producto</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body row g-3">

                <!-- FOLIO -->
                <div class="col-md-4">
                    <label class="form-label">No. Folio</label>
                    {{ form_producto.no_folio }}
                    {% if form_producto.no_folio.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.no_folio.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- NOMBRE -->
                <div class="col-md-4">
                    <label class="form-label">Nombre</label>
                    {{ form_producto.nombre }}
                    {% if form_producto.nombre.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.nombre.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- CATEGORIA -->
                <div class="col-md-4">
                    <label class="form-label">Categor√≠a</label>
                    {{ form_producto.categoria }}
                    {% if form_producto.categoria.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.categoria.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- DESCRIPCION -->
                <div class="col-md-12">
                    <label class="form-label">Descripci√≥n</label>
                    {{ form_producto.descripcion }}
                    {% if form_producto.descripcion.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.descripcion.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- PRECIO -->
                <div class="col-md-3">
                    <label class="form-label">Precio</label>
                    {{ form_producto.precio }}
                    {% if form_producto.precio.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.precio.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- PRECIO MAYOREO -->
                <div class="col-md-3">
                    <label class="form-label">Precio Mayoreo</label>
                    {{ form_producto.precio_mayoreo }}
                    {% if form_producto.precio_mayoreo.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.precio_mayoreo.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- UNIDAD -->
                <div class="col-md-3">
                    <label class="form-label">Unidad de medida</label>
                    {{ form_producto.unidad_medida }}
                    {% if form_producto.unidad_medida.errors %}
                        <div class="text-danger small mt-1">
                            {{ form_producto.unidad_medida.errors.0 }}
                        </div>
                    {% endif %}
                </div>

            </div>

            <div class="modal-footer">
            <a href="{% url 'inventario' %}" class="btn btn-secondary">
                    Cancelar
                </a>
                <button type="submit" class="btn btn-primary" name="guardar_producto" id="btnGuardarProducto">
                    Guardar producto
                </button>
            </div>

        </form>
    </div>
</div>


<!-- =======================
 JS PRO
======================== -->
<script>
let lastKeyTime = 0;

document.getElementById('formProducto').addEventListener('keydown', function(e) {

    if (e.key === 'Enter') {

        const now = new Date().getTime();
        const diff = now - lastKeyTime;

        lastKeyTime = now;

        // Si el ENTER viene muy r√°pido (menos de 50ms)
        // es casi seguro esc√°ner
        if (diff < 50) {
            e.preventDefault();
            console.log("ENTER de esc√°ner bloqueado");
        }
        // Si tarda m√°s, es humano y se permite
    }
});
</script>
<script>
document.getElementById('check-all').addEventListener('change', function () {
    document.querySelectorAll('input[name="productos"]').forEach(cb => {
        cb.checked = this.checked;
    });
});

/* BUSQUEDA EN VIVO */
document.getElementById('id_no_folio').addEventListener('keyup', function () {
    const value = this.value.toLowerCase();
    document.querySelectorAll('#tabla-inventario tbody tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
    });
});

/* AUTO GUARDADO STOCK */
document.querySelectorAll('.stock-input').forEach(input => {
    input.addEventListener('change', function () {
        this.closest('form').submit();
    });
});
</script>
<script>
const folioInput = document.getElementById("id_no_folio");
const btnGuardar = document.getElementById("btnGuardarProducto");

if (folioInput) {

    let timeout = null;

    folioInput.addEventListener("keyup", function() {

        clearTimeout(timeout);

        timeout = setTimeout(() => {

            const folio = this.value.trim().toUpperCase();

            // üîπ Si est√° vac√≠o ‚Üí permitir guardar
            if (!folio) {
                limpiarError();
                btnGuardar.disabled = false;
                return;
            }

            fetch(`/validar-folio/?folio=${folio}`)
                .then(response => response.json())
                .then(data => {

                    if (data.existe) {
                        mostrarError("‚ö† Ya existe un producto con ese folio");
                        btnGuardar.disabled = true;
                    } else {
                        limpiarError();
                        btnGuardar.disabled = false;
                    }
                });

        }, 400);
    });

    function mostrarError(mensaje) {
        let errorDiv = document.getElementById("folio-error");

        if (!errorDiv) {
            errorDiv = document.createElement("div");
            errorDiv.id = "folio-error";
            errorDiv.classList.add("text-danger", "small", "mt-1");
            folioInput.parentNode.appendChild(errorDiv);
        }

        errorDiv.innerText = mensaje;
    }

    function limpiarError() {
        const errorDiv = document.getElementById("folio-error");
        if (errorDiv) errorDiv.remove();
    }
}
</script>
{% if form_producto.errors or request.GET.editar %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const modalElement = document.getElementById('modalProducto');
    const formProducto = document.getElementById('formProducto');
    const btnGuardar = document.getElementById("btnGuardarProducto");

    if (!modalElement) return;

    const modal = bootstrap.Modal.getOrCreateInstance(modalElement);

    // üîπ Abrir si hay edici√≥n o errores
        modal.show();
 

    // üîπ Antes de cerrar ‚Üí liberar foco (ARREGLA aria-hidden)
    modalElement.addEventListener('hide.bs.modal', function () {
        if (document.activeElement) {
            document.activeElement.blur();
        }
    });

    // üîπ Despu√©s de cerrar ‚Üí limpiar todo
    modalElement.addEventListener('hidden.bs.modal', function () {

        formProducto.reset();

        // limpiar error folio
        const errorDiv = document.getElementById("folio-error");
        if (errorDiv) errorDiv.remove();

        if (btnGuardar) btnGuardar.disabled = false;

        const url = new URL(window.location);
        url.searchParams.delete('editar');
        window.history.replaceState({}, document.title, url.pathname);

    });

});
</script>
{% endif %}
<script>
document.addEventListener("DOMContentLoaded", function() {

    const inputBuscar = document.getElementById("buscarInventario");
    const form = document.getElementById("form-filtros");

    if (!inputBuscar || !form) return;

    let timeout;

    inputBuscar.addEventListener("keyup", function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            form.submit();
        }, 500);
    });

});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

    const inputBuscar = document.getElementById("buscarInventario");
    const tablaBody = document.getElementById("tabla-inventario");
    const form = document.getElementById("form-filtros");

    if (!inputBuscar || !tablaBody || !form) return;

    // üö´ Evitar recarga normal del formulario
    form.addEventListener("submit", function(e) {
        e.preventDefault();
    });

    let timeout;

    inputBuscar.addEventListener("keyup", function() {

        clearTimeout(timeout);

        timeout = setTimeout(() => {

            const query = new URLSearchParams({
                nombre: inputBuscar.value
            });

            fetch(window.location.pathname + "?" + query.toString(), {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.text())
            .then(html => {

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const nuevoBody = doc.getElementById("tabla-inventario");

                if (nuevoBody) {
                    tablaBody.innerHTML = nuevoBody.innerHTML;
                }

                // üî• Mantener foco y cursor
                inputBuscar.focus();
                inputBuscar.setSelectionRange(
                    inputBuscar.value.length,
                    inputBuscar.value.length
                );

            });

        }, 400);

    });

});
</script>


{% endblock %}
